dist: trusty

sudo: required

language: php

services:
  - docker

git:
  depth: 3

env:
  global:
    - DOCKER_COMPOSE_VERSION=1.22.0
    - DOCKER_COMPOSE_RELEASE="https://github.com/docker/compose/releases/download/$DOCKER_COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)"
    - SENTRY_DSN=

cache:
  directories:
    - "$HOME/.composer"
    - "vendor"

matrix:
  include:
    - php: 7.2
    - php: nightly
  fast_finish: true
  allow_failures:
    - php: nightly

before_install:
  # upgrade docker
  - docker --version
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
  - docker --version
  # install a recent docker-compose version
  - sudo curl --silent --fail --retry 3 --location --output /usr/bin/docker-compose --url $DOCKER_COMPOSE_RELEASE
  - docker-compose --version
  # disable xdebug if available
  - phpenv config-rm xdebug.ini || echo "xdebug not available"
  # disable default memory limit
  - echo memory_limit = -1 >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini

install:
  - composer install --no-interaction --no-progress --prefer-dist --ansi

before_script:
  - bin/console cache:warmup --env=test

script:
  - phpdbg -qrr vendor/bin/phpunit --colors=always --stderr --coverage-text --coverage-clover clover.xml
  - composer install --no-interaction --no-scripts --no-progress --prefer-dist --optimize-autoloader --no-dev --ansi

after_success:
  - bash <(curl -s https://codecov.io/bash) -f clover.xml

deploy:
  - provider: script
    script: |
      echo $(git rev-parse --short ${TRAVIS_COMMIT})
      docker build --file=docker/services/varnish/Dockerfile --tag=alcohol/pastebin-varnish:latest .
      docker build --file=docker/services/nginx/Dockerfile --tag=alcohol/pastebin-nginx:latest .
      docker build --file=docker/services/php-fpm/Dockerfile.dist --tag=alcohol/pastebin-fpm:latest --build-arg=RELEASE=$(git rev-parse --short ${TRAVIS_COMMIT}) .
      echo $DOCKERHUB_PASSWORD | docker login --username $DOCKERHUB_USERNAME --password-stdin
      docker push alcohol/pastebin-varnish:latest
      docker push alcohol/pastebin-nginx:latest
      docker push alcohol/pastebin-fpm:latest
      docker logout
    on:
      branch: master
